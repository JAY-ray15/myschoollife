<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ä¸€ä¸ªå­¦æœŸ | A Semester</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
</head>
<body>
    <!-- èƒŒæ™¯å±‚ -->
    <div class="sky-background">
        <div class="stars"></div>
        <div class="moon"></div>
        <div class="city-silhouette"></div>
    </div>

    <div id="app">
        <!-- å¼€å§‹ç•Œé¢ -->
        <div id="start-screen" class="screen active">
            <div class="title-container">
                <h1 class="game-title">ä¸€ä¸ªå­¦æœŸ</h1>
                <p class="game-subtitle">A SEMESTER</p>
                <p class="game-description">ä½ å°†åšå‡ºé€‰æ‹©ã€‚ç„¶åæ‰¿æ‹…åæœã€‚</p>
            </div>
            <button id="start-btn" class="pixel-btn">å¼€å§‹æ¸¸æˆ</button>
            <p class="control-hint">
                <span class="hint-icon">â‡¦</span> æ»‘åŠ¨æˆ–ç‚¹å‡» <span class="hint-icon">â‡¨</span>
            </p>
        </div>

        <!-- éš¾åº¦é€‰æ‹©ç•Œé¢ -->
        <div id="difficulty-screen" class="screen">
            <!-- éš¾åº¦é€‰æ‹©å¡ç‰ŒåŒºåŸŸ -->
            <div class="difficulty-card-area">
                <div id="difficulty-card" class="card difficulty-card" draggable="false">
                    <div class="card-texture"></div>

                    <!-- éš¾åº¦é€‰æ‹©æ ‡é¢˜ -->
                    <div class="difficulty-title-section">
                        <p id="difficulty-title" class="difficulty-title">æ–°ç”Ÿï¼Œä½ å‡†å¤‡å¥½è¿æ¥è¿™ä¸ªå­¦æœŸäº†å—ï¼Ÿ</p>
                    </div>

                    <!-- éš¾åº¦é€‰é¡¹å±•ç¤º -->
                    <div class="difficulty-options-display">
                        <div class="difficulty-option-preview" id="difficulty-preview">
                            <div class="preview-icon" id="preview-icon">âš–ï¸</div>
                            <div class="preview-name" id="preview-name">æ ‡å‡†æ¨¡å¼</div>
                            <div class="preview-desc" id="preview-desc">é»˜è®¤éš¾åº¦ï¼ŒçœŸå®å¤§å­¦ä½“éªŒ</div>
                        </div>
                    </div>

                    <!-- éš¾åº¦é€‰æ‹©æŒ‰é’® -->
                    <div class="difficulty-buttons">
                        <button id="diff-easy-btn" class="difficulty-button diff-button-left">
                            <span class="diff-icon">â˜•</span>
                            <span class="diff-text">è½»æ¾æ¨¡å¼</span>
                            <span class="diff-hint">æ–°æ‰‹å‹å¥½</span>
                        </button>
                        <button id="diff-standard-btn" class="difficulty-button diff-button-center selected">
                            <span class="diff-icon">âš–ï¸</span>
                            <span class="diff-text">æ ‡å‡†æ¨¡å¼</span>
                            <span class="diff-hint">çœŸå®ä½“éªŒ</span>
                        </button>
                        <button id="diff-hard-btn" class="difficulty-button diff-button-right">
                            <span class="diff-icon">ğŸ”¥</span>
                            <span class="diff-text">åœ°ç‹±æ¨¡å¼</span>
                            <span class="diff-hint">éšæ—¶ä¼šå´©</span>
                        </button>
                    </div>

                    <!-- ç¡®è®¤æŒ‰é’® -->
                    <button id="confirm-difficulty-btn" class="confirm-difficulty-btn">å¼€å§‹æŒ‘æˆ˜</button>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="game-screen" class="screen">
            <!-- é¡¶éƒ¨çŠ¶æ€æ  - æ¨ªå‘è¿›åº¦æ¡é£æ ¼ -->
            <div class="top-bar">
                <!-- å›åˆ°éš¾åº¦é€‰æ‹©æŒ‰é’® -->
                <button id="back-to-difficulty-btn" class="back-to-difficulty-btn" title="é‡æ–°é€‰æ‹©éš¾åº¦">
                    <span class="back-icon">â†º</span>
                </button>

                <div class="status-bars">
                    <!-- ç²¾åŠ› -->
                    <div class="status-bar">
                        <div class="status-bar-header">
                            <div class="status-bar-icon">â˜•</div>
                            <div class="status-bar-label">ç²¾åŠ›</div>
                        </div>
                        <div class="status-bar-track">
                            <div class="status-bar-fill energy-fill" id="energy-fill"></div>
                            <div class="status-bar-dot energy-dot" id="energy-dot"></div>
                        </div>
                    </div>

                    <!-- å­¦ä¸š -->
                    <div class="status-bar">
                        <div class="status-bar-header">
                            <div class="status-bar-icon">ğŸ“–</div>
                            <div class="status-bar-label">å­¦ä¸š</div>
                        </div>
                        <div class="status-bar-track">
                            <div class="status-bar-fill academics-fill" id="academics-fill"></div>
                            <div class="status-bar-dot academics-dot" id="academics-dot"></div>
                        </div>
                    </div>

                    <!-- å…³ç³» -->
                    <div class="status-bar">
                        <div class="status-bar-header">
                            <div class="status-bar-icon">â¤ï¸</div>
                            <div class="status-bar-label">å…³ç³»</div>
                        </div>
                        <div class="status-bar-track">
                            <div class="status-bar-fill connection-fill" id="connection-fill"></div>
                            <div class="status-bar-dot connection-dot" id="connection-dot"></div>
                        </div>
                    </div>

                    <!-- è‡ªæˆ‘ -->
                    <div class="status-bar">
                        <div class="status-bar-header">
                            <div class="status-bar-icon">ğŸª</div>
                            <div class="status-bar-label">è‡ªæˆ‘</div>
                        </div>
                        <div class="status-bar-track">
                            <div class="status-bar-fill self-fill" id="self-fill"></div>
                            <div class="status-bar-dot self-dot" id="self-dot"></div>
                        </div>
                    </div>
                </div>

                <!-- å‘¨æ•°æ˜¾ç¤º - å±…ä¸­åœ¨è¿›åº¦æ¡ä¸‹æ–¹ -->
                <div class="week-display">
                    <span class="week-text">ç¬¬</span>
                    <span id="week-number" class="week-number">1</span>
                    <span class="week-text">å‘¨</span>
                </div>
            </div>

            <!-- ä¸­å¤®å¡ç‰ŒåŒºåŸŸ -->
            <div class="card-area">
                <div id="card" class="card" draggable="false">
                    <div class="card-texture"></div>

                    <!-- äººç‰©åŒºåŸŸï¼ˆé¡¶éƒ¨ï¼‰ -->
                    <div class="character-section">
                        <div id="character-avatar" class="character-avatar">
                            <span id="avatar-emoji"></span>
                        </div>
                        <div id="character-info" class="character-info">
                            <span id="character-name" class="character-name"></span>
                            <span id="character-role" class="character-role"></span>
                        </div>
                    </div>

                    <!-- äº‹ä»¶æ–‡æ¡ˆï¼ˆä¸­éƒ¨ï¼‰ -->
                    <div class="card-content">
                        <p id="event-text" class="event-text"></p>
                    </div>

                    <!-- å¡ç‰Œåº•éƒ¨æŒ‰é’® -->
                    <div class="card-buttons">
                        <button id="btn-left" class="card-button card-button-left">
                            <span class="card-btn-icon">â—„</span>
                            <span class="card-btn-text" id="left-btn-text">å·¦é€‰é¡¹</span>
                        </button>
                        <button id="btn-right" class="card-button card-button-right">
                            <span class="card-btn-text" id="right-btn-text">å³é€‰é¡¹</span>
                            <span class="card-btn-icon">â–º</span>
                        </button>
                    </div>

                    <!-- æ»‘åŠ¨æç¤ºç®­å¤´ -->
                    <div class="swipe-indicators">
                        <div class="swipe-indicator-left" id="swipe-left-hint">
                            <span class="arrow">â—„</span>
                            <span class="hint-text" id="left-hint-text"></span>
                        </div>
                        <div class="swipe-indicator-right" id="swipe-right-hint">
                            <span class="hint-text" id="right-hint-text"></span>
                            <span class="arrow">â–º</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨æ»‘åŠ¨æç¤º -->
            <div class="bottom-bar">
                <div class="swipe-hint">
                    <span class="hint-arrow">â—„</span> å·¦æ»‘
                </div>
                <div class="swipe-hint">
                    å³æ»‘ <span class="hint-arrow">â–º</span>
                </div>
            </div>

            <!-- åé¦ˆæ¶ˆæ¯ -->
            <div id="feedback-message" class="feedback-message"></div>
        </div>

        <!-- ç»“å±€ç•Œé¢ -->
        <div id="ending-screen" class="screen">
            <div class="ending-overlay"></div>
            <div class="ending-content">
                <div class="ending-icon">âš°ï¸</div>
                <h2 id="ending-title" class="ending-title"></h2>
                <p id="ending-text" class="ending-text"></p>
                <div class="ending-divider"></div>
                <div id="ending-stats" class="ending-stats"></div>
            </div>
            <button id="restart-btn" class="pixel-btn">å†æ¥ä¸€å­¦æœŸ</button>
        </div>
    </div>

    <script>
    // ==================== éŸ³æ•ˆé…ç½® ====================
    const SFX = {
        swipe: new Howl({
            src: ['sounds/swipe.mp3'],
            volume: 0.7,
            preload: true
        }),
        positive: new Howl({
            src: ['sounds/positive.mp3'],
            volume: 0.8,
            preload: true
        }),
        negative: new Howl({
            src: ['sounds/negative.mp3'],
            volume: 0.6,
            preload: true
        }),
        gameover: new Howl({
            src: ['sounds/gameover.mp3'],
            volume: 0.8,
            preload: true
        }),
        pressure: new Howl({
            src: ['sounds/pressure.mp3'],
            volume: 0.9,
            preload: true
        })
    };

    // å®‰å…¨æ’­æ”¾å‡½æ•°
    function playSound(soundName) {
        try {
            if (SFX[soundName]) {
                SFX[soundName].stop();
                SFX[soundName].play();
            }
        } catch (e) {
            console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', soundName, e);
        }
    }

    // åˆå§‹åŒ–éŸ³æ•ˆé¢„åŠ è½½
    function initAudio() {
        Object.values(SFX).forEach(sound => {
            sound.once('load', () => {
                console.log('éŸ³æ•ˆåŠ è½½å®Œæˆ');
            });
            sound.once('loaderror', () => {
                console.log('éŸ³æ•ˆåŠ è½½å¤±è´¥');
            });
        });
    }

    // ==================== æ¸¸æˆçŠ¶æ€ ====================
    const gameState = {
        energy: 50,
        academics: 50,
        connection: 50,
        self: 50,
        week: 1,
        daysLeft: 112,
        ddlPressure: 0,
        gameOver: false,
        isAnimating: false,
        usedEvents: [],
        inHighPressurePeriod: false,
        highPressureWeeksLeft: 0
    };

    // ==================== éš¾åº¦é…ç½® ====================
    const DIFFICULTY_CONFIG = {
        easy: {
            name: 'è½»æ¾æ¨¡å¼',
            icon: 'â˜•',
            description: 'åˆå§‹çŠ¶æ€è¾ƒé«˜ï¼ŒDDLå‹åŠ›æ…¢ï¼Œé€‚åˆç¬¬ä¸€æ¬¡ç©',
            hint: 'æ–°æ‰‹å‹å¥½ï¼Œå¤§å¤šæ•°é€‰æ‹©éƒ½èƒ½å®‰å…¨è¿‡å…³',
            initialStats: { energy: 95, academics: 90, connection: 85, self: 90 },
            ddlMultiplier: { min: 0.8, max: 1.2 },
            ddlThreshold: 55,
            negativeMultiplier: 0.7,
            positiveMultiplier: 1.0,
            highPressureEnergyMultiplier: 1.2,
            maxWeeks: 65
        },
        standard: {
            name: 'æ ‡å‡†æ¨¡å¼',
            icon: 'âš–ï¸',
            description: 'é»˜è®¤éš¾åº¦ï¼ŒçœŸå®å¤§å­¦ä½“éªŒ',
            hint: 'éœ€è¦ç­–ç•¥å–èˆï¼Œ50%å‡ ç‡è‡ªç„¶æ¯•ä¸š',
            initialStats: { energy: 85, academics: 80, connection: 75, self: 80 },
            ddlMultiplier: { min: 1.2, max: 2.0 },
            ddlThreshold: 45,
            negativeMultiplier: 1.0,
            positiveMultiplier: 1.0,
            highPressureEnergyMultiplier: 1.5,
            maxWeeks: 55
        },
        hard: {
            name: 'åœ°ç‹±æ¨¡å¼',
            icon: 'ğŸ”¥',
            description: 'åˆå§‹çŠ¶æ€ä½ï¼ŒDDLå‹åŠ›å¿«ï¼ŒçŠ¶æ€æ‰£å‡æ”¾å¤§ï¼ŒæŒ‘æˆ˜ä½ çš„æé™',
            hint: 'å’–å•¡æ°¸è¿œä¸å¤Ÿç”¨ï¼ŒDDLå¦‚å½±éšå½¢ï¼Œéšæ—¶å¯èƒ½å´©',
            initialStats: { energy: 65, academics: 60, connection: 55, self: 60 },
            ddlMultiplier: { min: 2.5, max: 4.0 },
            ddlThreshold: 35,
            negativeMultiplier: 1.65,
            positiveMultiplier: 0.7,
            highPressureEnergyMultiplier: 2.0,
            highPressureChance: 0.9,
            highPressureDuration: 10,
            maxWeeks: 45,
            hasDebuffEvents: true
        }
    };

    let currentDifficulty = 'standard';

    // ==================== è§’è‰²æ•°æ® ====================
    const CHARACTERS = {
        narrator: { name: '', role: '', avatar: 'ğŸ“' },
        roommate: { name: 'å®¤å‹', role: 'å®¤å‹', avatar: 'ğŸ›ï¸' },
        professor: { name: 'ç‹æ•™æˆ', role: 'ä»»è¯¾è€å¸ˆ', avatar: 'ğŸ‘¨â€ğŸ«' },
        crush: { name: 'TA', role: 'æš—æ‹çš„äºº', avatar: 'ğŸ’•' },
        counselor: { name: 'è¾…å¯¼å‘˜', role: 'è¾…å¯¼å‘˜', avatar: 'ğŸ“‹' },
        parent: { name: 'å¦ˆå¦ˆ', role: 'å®¶äºº', avatar: 'ğŸ“' },
        friend: { name: 'æœ‹å‹', role: 'æœ‹å‹', avatar: 'ğŸ‘¥' },
        self: { name: '', role: 'å†…å¿ƒ', avatar: 'ğŸ¤”' },
        club: { name: 'ç¤¾é•¿', role: 'ç¤¾å›¢', avatar: 'ğŸª' },
        nobody: { name: '', role: '', avatar: 'ğŸ“' }
    };

    // ==================== äº‹ä»¶æ•°æ® ====================
    const EVENTS = [
        {
            text: "æ—©ä¸Šä¸ƒç‚¹ï¼Œé—¹é’Ÿå“äº†ã€‚ä½ æ˜¨æ™šä¸‰ç‚¹æ‰ç¡ã€‚",
            character: CHARACTERS.self,
            left: { text: "èµ·åºŠå»ä¸Šè¯¾", effect: { E: -15, A: +10 } },
            right: { text: "å†ç¡ä¸€å°æ—¶", effect: { E: +10, A: -15 } }
        },
        {
            text: "å®¤å‹åœ¨æ‰“æ¸¸æˆï¼Œå£°éŸ³å¾ˆå¤§ï¼Œä½ æƒ³ä¼‘æ¯ã€‚",
            character: CHARACTERS.roommate,
            left: { text: "å¿äº†", effect: { E: -10, S: -5 } },
            right: { text: "è®©ä»–å°å£°ç‚¹", effect: { C: -10, E: +5 } }
        },
        {
            text: "ç¤¾å›¢ç¾¤é‡Œåœ¨è®¨è®ºå‘¨æœ«æ´»åŠ¨ï¼Œä½†ä½ è¿˜æœ‰ä½œä¸šæ²¡å†™å®Œã€‚",
            character: CHARACTERS.club,
            left: { text: "å‚åŠ æ´»åŠ¨", effect: { C: +15, A: -10 } },
            right: { text: "å†™ä½œä¸š", effect: { A: +10, C: -10 } }
        },
        {
            text: "æœ‹å‹åœˆé‡Œï¼ŒåŒå­¦ä»¬éƒ½åœ¨æ™’å„ç§æˆå°±å’Œå®ä¹ offerã€‚",
            character: CHARACTERS.self,
            left: { text: "ç»§ç»­åˆ·", effect: { S: -15, E: -5 } },
            right: { text: "æ”¾ä¸‹æ‰‹æœº", effect: { S: +5, C: -5 } }
        },
        {
            text: "æœŸä¸­è€ƒè¯•è¿˜æœ‰ä¸€å‘¨ï¼Œä½ æ‰å¼€å§‹å¤ä¹ ã€‚",
            character: CHARACTERS.professor,
            left: { text: "é€šå®µå¤ä¹ ", effect: { E: -20, A: +15 } },
            right: { text: "æ­£å¸¸å¤ä¹ ", effect: { A: +5, E: -5 } }
        },
        {
            text: "ã€Œä»Šæ™šæœ‰ç©ºå—ï¼Ÿã€å¯¹æ–¹å‘æ¥æ¶ˆæ¯ã€‚",
            character: CHARACTERS.crush,
            left: { text: "ç­”åº”", effect: { C: +20, A: -10, E: -5 } },
            right: { text: "æ‹’ç»ï¼Œè¦å­¦ä¹ ", effect: { A: +5, S: -10, C: -5 } }
        },
        {
            text: "è¾…å¯¼å‘˜å‘æ¶ˆæ¯ï¼Œè¯´ä½ æœ€è¿‘å‡ºå‹¤ç‡æœ‰ç‚¹ä½ã€‚",
            character: CHARACTERS.counselor,
            left: { text: "é“æ­‰ä¿è¯æ”¹æ­£", effect: { S: -5, A: +5 } },
            right: { text: "è£…æ­»ä¸å›", effect: { S: +5, A: -10 } }
        },
        {
            text: "ä½ å‘ç°è‡ªå·±åœ¨è¯¾å ‚ä¸Šå®Œå…¨å¬ä¸æ‡‚è€å¸ˆåœ¨è®²ä»€ä¹ˆã€‚",
            character: CHARACTERS.professor,
            left: { text: "è¯¾åè‡ªå­¦", effect: { E: -15, A: +10 } },
            right: { text: "æ‘†çƒ‚ä¸ç®¡", effect: { E: +5, A: -15, S: -5 } }
        },
        {
            text: "çˆ¶æ¯æ‰“æ¥ç”µè¯ï¼Œé—®ä½ è¿™æœ€è¿‘æ€ä¹ˆæ ·ã€‚",
            character: CHARACTERS.parent,
            left: { text: "æŠ¥å–œä¸æŠ¥å¿§", effect: { S: -10, C: +5 } },
            right: { text: "è¯´å®è¯", effect: { S: +5, C: -5 } }
        },
        {
            text: "å®¤å‹è¿‡ç”Ÿæ—¥ï¼Œé‚€è¯·ä½ ä¸€èµ·å»èšé¤ã€‚",
            character: CHARACTERS.roommate,
            left: { text: "å»", effect: { C: +15, E: -10, A: -5 } },
            right: { text: "ä¸å»", effect: { A: +5, C: -15 } }
        },
        {
            text: "ä½ çœ‹åˆ°æœ‰äººåœ¨åšå…¼èŒï¼Œä¸€ä¸ªæœˆèƒ½èµšä¸¤åƒå—ã€‚",
            character: CHARACTERS.nobody,
            left: { text: "ä¹Ÿå»æ‰¾å…¼èŒ", effect: { E: -15, A: -10, S: +5 } },
            right: { text: "ä¸“å¿ƒå­¦ä¹ ", effect: { A: +5, E: +5 } }
        },
        {
            text: "æ·±å¤œï¼Œä½ åˆ·è§†é¢‘åˆ·åˆ°å‡Œæ™¨ä¸¤ç‚¹ã€‚",
            character: CHARACTERS.self,
            left: { text: "ç»§ç»­åˆ·", effect: { E: -10, S: -10 } },
            right: { text: "å¼ºåˆ¶ç¡è§‰", effect: { E: +5, S: -5 } }
        },
        {
            text: "è€å¸ˆè¯´ä¸‹å‘¨è¦äº¤å¤§ä½œä¸šï¼Œç°åœ¨å¼€å§‹å—ï¼Ÿ",
            character: CHARACTERS.professor,
            left: { text: "ç°åœ¨å¼€å§‹", effect: { E: -10, A: +15 } },
            right: { text: "å†è¯´", effect: { E: +5, A: -10 } }
        },
        {
            text: "æœ‹å‹å¿ƒæƒ…ä¸å¥½ï¼Œæ‰¾ä½ å€¾è¯‰ã€‚",
            character: CHARACTERS.friend,
            left: { text: "é™ªä»–èŠ", effect: { C: +15, E: -10 } },
            right: { text: "æ•·è¡ä¸€ä¸‹", effect: { C: -10, E: +5 } }
        },
        {
            text: "ä½ å‘ç°å®¤å‹åœ¨èƒŒåè®®è®ºä½ ã€‚",
            character: CHARACTERS.roommate,
            left: { text: "è´¨é—®ä»–", effect: { C: -15, S: +5 } },
            right: { text: "è£…ä¸çŸ¥é“", effect: { S: -10, E: -5 } }
        },
        {
            text: "å­¦æ ¡ä¸¾åŠç¯®çƒèµ›ï¼Œç­çº§éœ€è¦äººå‚åŠ ã€‚",
            character: CHARACTERS.friend,
            left: { text: "æŠ¥å", effect: { C: +10, E: -15, A: -5 } },
            right: { text: "ä¸å‚åŠ ", effect: { A: +5, C: -5 } }
        },
        {
            text: "ä½ åœ¨ç½‘ä¸Šçœ‹åˆ°ä¸€ç¯‡å…³äºã€Œå†…å·ã€çš„æ–‡ç« ã€‚",
            character: CHARACTERS.self,
            left: { text: "ç„¦è™‘åœ°è¯»å®Œ", effect: { S: -15, E: -5 } },
            right: { text: "åˆ’èµ°", effect: { S: +5 } }
        },
        {
            text: "å°ç»„ä½œä¸šï¼Œé˜Ÿå‹éƒ½æ²¡åŠ¨é™ã€‚",
            character: CHARACTERS.friend,
            left: { text: "ä¸€ä¸ªäººåšå®Œ", effect: { E: -20, A: +10, S: -5 } },
            right: { text: "å‚¬é˜Ÿå‹", effect: { C: -10, E: -5 } }
        },
        {
            text: "å‘¨æœ«ï¼Œä½ å¯ä»¥å»å›¾ä¹¦é¦†æˆ–è€…ç¡è§‰ã€‚",
            character: CHARACTERS.nobody,
            left: { text: "å›¾ä¹¦é¦†", effect: { A: +10, E: -10 } },
            right: { text: "ç¡ä¸€å¤©", effect: { E: +15, A: -10 } }
        },
        {
            text: "ä½ å¼€å§‹æ€€ç–‘è‡ªå·±é€‰çš„ä¸“ä¸šåˆ°åº•æ˜¯ä¸æ˜¯è‡ªå·±å–œæ¬¢çš„ã€‚",
            character: CHARACTERS.self,
            left: { text: "æ·±å…¥æ€è€ƒ", effect: { S: +10, E: -10 } },
            right: { text: "ä¸æƒ³äº†", effect: { S: -10, E: +5 } }
        },
        // DDLå‹åŠ›ç›¸å…³äº‹ä»¶
        {
            text: "ä¸‹å‘¨æœ‰ä¸‰ä¸ªDDLåŒæ—¶åˆ°æ¥ã€‚ä½ æ„Ÿè§‰åˆ°äº†å—ï¼Ÿ",
            character: CHARACTERS.professor,
            left: { text: "å¼€å§‹èµ¶å·¥", effect: { E: -20, A: +10 } },
            right: { text: "å…ˆç©å†è¯´", effect: { A: -15, E: +5 } },
            isDDL: true
        },
        {
            text: "ä½ å‘ç°è‡ªå·±æœ‰ä¸¤å‘¨æ²¡å»ä¸Šè¯¾äº†ã€‚",
            character: CHARACTERS.counselor,
            left: { text: "è¡¥è¯¾", effect: { E: -15, A: +10 } },
            right: { text: "ç»§ç»­é€ƒ", effect: { A: -20, S: -5 } },
            isDDL: true
        },
        {
            text: "è€ƒè¯•æ—¶é—´è¡¨å‡ºæ¥äº†ï¼Œä½ çš„è€ƒè¯•è¿ç€å››å¤©ã€‚",
            character: CHARACTERS.professor,
            left: { text: "åˆ¶å®šè®¡åˆ’", effect: { E: -5, A: +10, S: +5 } },
            right: { text: "éšç¼˜", effect: { S: -10, A: -10 } },
            isDDL: true
        },
        {
            text: "ä½ å‘ç°è¿˜æœ‰ä¸‰å¤©å°±è¦äº¤è®ºæ–‡ï¼Œè€Œä½ åªå†™äº†æ ‡é¢˜ã€‚",
            character: CHARACTERS.professor,
            left: { text: "é€šå®µå†™", effect: { E: -25, A: +15 } },
            right: { text: "ç”³è¯·å»¶æœŸ", effect: { A: -10, S: -5 } },
            isDDL: true
        },
        {
            text: "å®¤å‹é—®ä½ å¤ä¹ å¾—æ€ä¹ˆæ ·äº†ã€‚ä½ è§‰å¾—å‘¢ï¼Ÿ",
            character: CHARACTERS.roommate,
            left: { text: "è¿˜è¡Œå§", effect: { S: -5, C: +5 } },
            right: { text: "åˆ«é—®äº†", effect: { C: -10, S: -5 } },
            isDDL: true
        },
        {
            text: "ä½ åœ¨æœ‹å‹åœˆçœ‹åˆ°åˆ«äººå·²ç»å¤ä¹ å®Œä¸‰è½®äº†ã€‚",
            character: CHARACTERS.self,
            left: { text: "æ…Œäº†", effect: { S: -15, E: -10 } },
            right: { text: "å…³æˆ‘ä»€ä¹ˆäº‹", effect: { S: +5, C: -5 } },
            isDDL: true
        },
        {
            text: "å‡Œæ™¨ä¸‰ç‚¹ï¼Œä½ è¿˜åœ¨èµ¶ddlï¼Œå’–å•¡å·²ç»ä¸ç®¡ç”¨äº†ã€‚",
            character: CHARACTERS.self,
            left: { text: "ç»§ç»­", effect: { E: -25, A: +10 } },
            right: { text: "ç¡è§‰", effect: { A: -15, E: +10 } },
            isDDL: true
        },
        {
            text: "ä½ å‘ç°è‡ªå·±å·²ç»è®°ä¸æ¸…ä¸Šæ¬¡å¥½å¥½åƒé¥­æ˜¯ä»€ä¹ˆæ—¶å€™äº†ã€‚",
            character: CHARACTERS.nobody,
            left: { text: "å»åƒé¡¿å¥½çš„", effect: { E: +10, A: -5 } },
            right: { text: "ç»§ç»­èµ¶ddl", effect: { E: -15, A: +5 } },
            isDDL: true
        }
    ];

    // ==================== åœ°ç‹±æ¨¡å¼ä¸“å±Debuffäº‹ä»¶æ±  ====================
    const DEBUFF_EVENTS = [
        {
            text: "ã€Œå‘çƒ§38.5åº¦ï¼Œå®¤å‹è¯´ä½ è„¸çº¢å¾—åƒçŒ´å±è‚¡ã€‚ã€",
            character: { name: '', role: 'ç”Ÿç—…', avatar: 'ğŸ¤’' },
            left: { text: "ç¡¬æ’‘ç€å»ä¸Šè¯¾", effect: { E: -25, A: +5 } },
            right: { text: "èººå®¿èˆä¼‘æ¯", effect: { E: -10, A: -15 } }
        },
        {
            text: "ã€Œæƒ…ç»ªå´©æºƒï¼Œåœ¨å•æ‰€å“­äº†åŠå°æ—¶ï¼Œå‡ºæ¥è¿˜å¾—å‡è£…æ²¡äº‹ã€‚ã€",
            character: { name: '', role: 'æƒ…ç»ªå´©æºƒ', avatar: 'ğŸ˜­' },
            left: { text: "æ‰¾æœ‹å‹å€¾è¯‰", effect: { C: +10, S: +5 } },
            right: { text: "ä¸€ä¸ªäººæ‰›ç€", effect: { S: -20, E: -10 } }
        },
        {
            text: "ã€Œå®¤å‹å‡Œæ™¨ä¸‰ç‚¹è¿˜åœ¨å¼€éº¦æ‰“æ¸¸æˆï¼Œä½ æ˜å¤©æ—©ä¸Šæœ‰è¯¾ã€‚ã€",
            character: { name: 'å®¤å‹', role: 'å†²çª', avatar: 'ğŸ®' },
            left: { text: "å¿äº†", effect: { E: -15, S: -10 } },
            right: { text: "çˆ†å‘äº‰åµ", effect: { C: -25, S: +5 } }
        },
        {
            text: "ã€Œæ‰‹æœºçªç„¶æ”¶åˆ°ï¼šæŸç§‘ä½œä¸š0åˆ†ï¼Œå› ä¸ºä½ äº¤é”™äº†æ–‡ä»¶ã€‚ã€",
            character: { name: 'è€å¸ˆ', role: 'äº‹æ•…', avatar: 'ğŸ“' },
            left: { text: "æ±‚è€å¸ˆé‡åˆ¤", effect: { S: -15, A: +5 } },
            right: { text: "æ¥å—ç°å®", effect: { A: -20, S: -10 } }
        },
        {
            text: "ã€Œé’±åŒ…ä¸¢äº†ï¼Œé‡Œé¢æœ‰è¿™ä¸ªæœˆçš„ç”Ÿæ´»è´¹ã€‚ã€",
            character: { name: '', role: 'æ„å¤–', avatar: 'ğŸ’¸' },
            left: { text: "å‘å®¶é‡Œè¦", effect: { S: -15, E: +5 } },
            right: { text: "è‡ªå·±æ‰›ç€", effect: { E: -20, C: -10 } }
        },
        {
            text: "ã€Œè¿ç»­å¤±çœ ç¬¬äº”å¤©ï¼Œä½ çœ‹ç€å¤©èŠ±æ¿åˆ°å¤©äº®ã€‚ã€",
            character: { name: '', role: 'å¤±çœ ', avatar: 'ğŸ˜µ' },
            left: { text: "åƒè¤ªé»‘ç´ ", effect: { E: -10, S: -5 } },
            right: { text: "ç¡¬æ‰›ç€", effect: { E: -25, S: -15 } }
        },
        {
            text: "ã€Œæš—æ‹çš„äººå®˜å®£æ‹æƒ…äº†ï¼Œå¯¹æ–¹ä¸æ˜¯ä½ ã€‚ã€",
            character: { name: '', role: 'å¿ƒç¢', avatar: 'ğŸ’”' },
            left: { text: "èº²å®¿èˆå“­", effect: { S: -20, E: -10 } },
            right: { text: "å‡è£…ç¥ç¦", effect: { S: -25, C: -5 } }
        },
        {
            text: "ã€Œç¤¾å›¢ç¾¤é‡Œ@ä½ ï¼Œè¯´æ´»åŠ¨ä½ ç¼ºå¸­äº†3æ¬¡ï¼Œè¦é€€ä½ ã€‚ã€",
            character: { name: 'ç¤¾é•¿', role: 'è­¦å‘Š', avatar: 'âš ï¸' },
            left: { text: "é“æ­‰è§£é‡Š", effect: { S: -10, C: +5 } },
            right: { text: "ç›´æ¥é€€ç¤¾", effect: { C: -15, A: +5 } }
        }
    ];

    // ==================== ç»“å±€æ•°æ® ====================
    const ENDINGS = {
        energy: {
            title: "å´©æºƒ",
            text: "ä½ å½»åº•å´©æºƒäº†ã€‚\n\nç¡çœ ä¸è¶³è®©ä½ è¿èµ°è·¯éƒ½æ‰“æ™ƒï¼Œæœ‰ä¸€å¤©æ—©ä¸Šï¼Œä½ æ— è®ºå¦‚ä½•ä¹Ÿèµ·ä¸æ¥äº†ã€‚è¾…å¯¼å‘˜æŠŠä½ é€åˆ°äº†åŒ»é™¢ï¼ŒåŒ»ç”Ÿè¯´ä½ éœ€è¦ä¼‘æ¯ã€‚å­¦æœŸæå‰ç»“æŸã€‚",
            icon: "ğŸ’€"
        },
        academics: {
            title: "æŒ‚ç§‘",
            text: "å„ç§‘æŒ‚ç§‘ï¼Œä½ çš„å­¦æœŸæˆç»©ä»¥é›¶å‘Šç»ˆã€‚\n\nè¿æœ€åŸºæœ¬çš„å­¦åˆ†éƒ½æ²¡ä¿ä½ã€‚çœ‹ç€æˆç»©å•ä¸Šé‚£ä¸€ä¸²åˆºçœ¼çš„çº¢è‰²ï¼Œä½ ä¸çŸ¥é“è¯¥æ€ä¹ˆå’Œçˆ¶æ¯è¯´ã€‚",
            icon: "ğŸ“•"
        },
        connection: {
            title: "å­¤ç‹¬",
            text: "æœ‹å‹å’Œå®¤å‹å…¨éƒ½ç¦»ä½ è€Œå»ã€‚\n\nä½ å­¤ç‹¬åœ°åº¦è¿‡äº†æ•´ä¸ªå­¦æœŸã€‚æœ‰ä¸€å¤©ä½ æƒ³æ‰¾ä¸ªäººè¯´è¯ï¼Œç¿»å¼€é€šè®¯å½•ï¼Œå´å‘ç°ä¸çŸ¥é“è¯¥æ‰“ç»™è°ã€‚",
            icon: "ğŸ‘¤"
        },
        self: {
            title: "è¿·å¤±",
            text: "ä½ å®Œå…¨è¿·å¤±äº†è‡ªå·±ã€‚\n\nä¸çŸ¥é“ä¸ºä½•è€Œå­¦ï¼Œä¸ºè°è€ŒåŠªåŠ›ã€‚ä½ åªæ˜¯åœ¨æœºæ¢°åœ°æ´»ç€ï¼Œåƒä¸€å…·æ²¡æœ‰çµé­‚çš„èº¯å£³ã€‚",
            icon: "ğŸ”®"
        },
        semester: {
            balanced: {
                title: "ä¸€ä¸ªæ™®é€šçš„å­¦æœŸ",
                text: "å­¦æœŸç»“æŸäº†ã€‚\n\nä½ æ´»ä¸‹æ¥äº†ã€‚æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æƒŠå–œï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„é—æ†¾ã€‚è¿™å°±æ˜¯å¤§å¤šæ•°äººçš„å¤§å­¦ç”Ÿæ´»å§ã€‚",
                icon: "ğŸ“"
            },
            social: {
                title: "ä¸€ä¸ªçƒ­é—¹çš„å­¦æœŸ",
                text: "å­¦æœŸç»“æŸäº†ã€‚\n\nä½ è®¤è¯†äº†å¾ˆå¤šæœ‹å‹ï¼Œå‚åŠ äº†å¾ˆå¤šæ´»åŠ¨ï¼Œä½†æˆç»©å•ä¸Šçš„æ•°å­—æé†’ä½ ï¼Œæœ‰äº›ä¸œè¥¿è¢«ä½ å¿½ç•¥äº†ã€‚",
                icon: "ğŸ‰"
            },
            academic: {
                title: "ä¸€ä¸ªåŠªåŠ›çš„å­¦æœŸ",
                text: "å­¦æœŸç»“æŸäº†ã€‚\n\nä½ çš„æˆç»©å¾ˆå¥½ï¼Œä½†å½“ä½ æ”¾ä¸‹ä¹¦æœ¬ï¼Œå‘ç°è‡ªå·±å¥½åƒé”™è¿‡äº†å¾ˆå¤šåˆ«çš„ä¸œè¥¿ã€‚",
                icon: "ğŸ“š"
            },
            awakened: {
                title: "ä¸€ä¸ªè§‰é†’çš„å­¦æœŸ",
                text: "å­¦æœŸç»“æŸäº†ã€‚\n\nä½ æ‰¾åˆ°äº†è‡ªå·±çœŸæ­£æƒ³è¦çš„ä¸œè¥¿ï¼Œè™½ç„¶è¿‡ç¨‹å¾ˆç—›è‹¦ï¼Œä½†ä½ ç»ˆäºæ˜ç™½äº†è‡ªå·±æ˜¯è°ã€‚",
                icon: "âœ¨"
            }
        }
    };

    // ==================== DOM å…ƒç´  ====================
    const elements = {
        startScreen: document.getElementById('start-screen'),
        difficultyScreen: document.getElementById('difficulty-screen'),
        gameScreen: document.getElementById('game-screen'),
        endingScreen: document.getElementById('ending-screen'),
        startBtn: document.getElementById('start-btn'),
        restartBtn: document.getElementById('restart-btn'),
        card: document.getElementById('card'),
        eventText: document.getElementById('event-text'),
        avatarEmoji: document.getElementById('avatar-emoji'),
        characterName: document.getElementById('character-name'),
        characterRole: document.getElementById('character-role'),
        weekDisplay: document.getElementById('week-number'),
        endingTitle: document.getElementById('ending-title'),
        endingText: document.getElementById('ending-text'),
        endingStats: document.getElementById('ending-stats'),
        endingIcon: document.querySelector('.ending-icon'),
        backToDifficultyBtn: document.getElementById('back-to-difficulty-btn'),
        btnLeft: document.getElementById('btn-left'),
        btnRight: document.getElementById('btn-right'),
        leftBtnText: document.getElementById('left-btn-text'),
        rightBtnText: document.getElementById('right-btn-text'),
        leftHintText: document.getElementById('left-hint-text'),
        rightHintText: document.getElementById('right-hint-text'),
        swipeLeftHint: document.getElementById('swipe-left-hint'),
        swipeRightHint: document.getElementById('swipe-right-hint'),
        feedbackMessage: document.getElementById('feedback-message'),
        difficultyCard: document.getElementById('difficulty-card'),
        previewIcon: document.getElementById('preview-icon'),
        previewName: document.getElementById('preview-name'),
        previewDesc: document.getElementById('preview-desc'),
        diffEasyBtn: document.getElementById('diff-easy-btn'),
        diffStandardBtn: document.getElementById('diff-standard-btn'),
        diffHardBtn: document.getElementById('diff-hard-btn'),
        confirmDifficultyBtn: document.getElementById('confirm-difficulty-btn')
    };

    // çŠ¶æ€è¿›åº¦æ¡å…ƒç´ 
    const statusElements = {
        energy: {
            fill: document.getElementById('energy-fill'),
            dot: document.getElementById('energy-dot')
        },
        academics: {
            fill: document.getElementById('academics-fill'),
            dot: document.getElementById('academics-dot')
        },
        connection: {
            fill: document.getElementById('connection-fill'),
            dot: document.getElementById('connection-dot')
        },
        self: {
            fill: document.getElementById('self-fill'),
            dot: document.getElementById('self-dot')
        }
    };

    // æ»‘åŠ¨é…ç½®
    const SWIPE_THRESHOLD = 100;

    // å½“å‰äº‹ä»¶æ•°æ®
    let currentEvent = null;

    // ==================== æ»‘åŠ¨å˜é‡ ====================
    let startX = 0;
    let currentX = 0;
    let isDragging = false;

    // ==================== åˆå§‹åŒ–æ¸¸æˆ ====================
    function initGame(difficulty = 'standard') {
        currentDifficulty = difficulty;
        const config = DIFFICULTY_CONFIG[difficulty];

        gameState.energy = config.initialStats.energy;
        gameState.academics = config.initialStats.academics;
        gameState.connection = config.initialStats.connection;
        gameState.self = config.initialStats.self;
        gameState.week = 1;
        gameState.daysLeft = 112;
        gameState.ddlPressure = 0;
        gameState.gameOver = false;
        gameState.isAnimating = false;
        gameState.usedEvents = [];
        gameState.inHighPressurePeriod = false;
        gameState.highPressureWeeksLeft = 0;
        currentEvent = null;

        startX = 0;
        currentX = 0;
        isDragging = false;

        elements.card.style.transition = '';
        elements.card.style.transform = '';
        elements.card.style.opacity = '';
        elements.card.classList.remove('dragging', 'swipe-left-complete', 'swipe-right-complete', 'entering', 'snap-back');

        if (elements.swipeLeftHint) {
            elements.swipeLeftHint.style.opacity = '0';
            elements.swipeLeftHint.style.transform = '';
        }
        if (elements.swipeRightHint) {
            elements.swipeRightHint.style.opacity = '0';
            elements.swipeRightHint.style.transform = '';
        }

        removeEventListeners();

        const cardButtons = elements.card.querySelectorAll('.card-button');
        cardButtons.forEach(btn => {
            btn.onclick = null;
            btn.style.animation = '';
            btn.style.transform = '';
            btn.style.boxShadow = '';
        });

        showScreen('game');
        updateStatusDots();

        setTimeout(() => {
            nextEvent();
        }, 50);
    }

    // ==================== æ˜¾ç¤ºç•Œé¢ ====================
    function showScreen(screenName) {
        elements.startScreen.classList.remove('active');
        elements.difficultyScreen.classList.remove('active');
        elements.gameScreen.classList.remove('active');
        elements.endingScreen.classList.remove('active');

        switch(screenName) {
            case 'start':
                elements.startScreen.classList.add('active');
                break;
            case 'difficulty':
                elements.difficultyScreen.classList.add('active');
                break;
            case 'game':
                elements.gameScreen.classList.add('active');
                break;
            case 'ending':
                elements.endingScreen.classList.add('active');
                break;
        }
    }

    // ==================== è·å–ä¸‹ä¸€ä¸ªäº‹ä»¶ ====================
    function getNextEvent() {
        const availableEvents = EVENTS.filter(event => !gameState.usedEvents.includes(event.text));

        if (availableEvents.length === 0) {
            gameState.usedEvents = [];
            return getNextEvent();
        }

        let eventPool = availableEvents;
        const config = DIFFICULTY_CONFIG[currentDifficulty];
        const threshold = config.ddlThreshold || 45;

        if (gameState.ddlPressure > threshold) {
            const ddlEvents = availableEvents.filter(e => e.isDDL);
            if (ddlEvents.length > 0 && Math.random() < 0.6) {
                eventPool = ddlEvents;
            }
        }

        const randomIndex = Math.floor(Math.random() * eventPool.length);
        const selectedEvent = eventPool[randomIndex];
        gameState.usedEvents.push(selectedEvent.text);

        return selectedEvent;
    }

    function getDebuffEvent() {
        const randomIndex = Math.floor(Math.random() * DEBUFF_EVENTS.length);
        return DEBUFF_EVENTS[randomIndex];
    }

    // ==================== é«˜å‹æœŸå¤„ç† ====================
    function handleHighPressurePeriod() {
        const config = DIFFICULTY_CONFIG[currentDifficulty];

        if (!gameState.inHighPressurePeriod) {
            const threshold = config.ddlThreshold || 45;
            if (gameState.ddlPressure > threshold) {
                const chance = config.highPressureChance || 0.5;
                if (Math.random() < chance) {
                    gameState.inHighPressurePeriod = true;
                    gameState.highPressureWeeksLeft = config.highPressureDuration || 5;
                    playSound('pressure');
                }
            }
        } else {
            gameState.highPressureWeeksLeft--;
            if (gameState.highPressureWeeksLeft <= 0) {
                gameState.inHighPressurePeriod = false;
            }
        }
    }

    // ==================== æ˜¾ç¤ºä¸‹ä¸€ä¸ªäº‹ä»¶ ====================
    function nextEvent() {
        const config = DIFFICULTY_CONFIG[currentDifficulty];

        if (gameState.week > config.maxWeeks) {
            endGame('semester');
            return;
        }

        elements.weekDisplay.textContent = gameState.week;

        if (config.hasDebuffEvents && gameState.week % 10 === 0 && gameState.week > 1) {
            const debuffEvent = getDebuffEvent();
            displayEvent(debuffEvent);
        } else {
            const event = getNextEvent();
            displayEvent(event);
        }

        handleHighPressurePeriod();
        updateStatusDots();
    }

    // ==================== æ˜¾ç¤ºäº‹ä»¶ ====================
    function displayEvent(event) {
        currentEvent = event;
        elements.eventText.textContent = event.text;

        if (event.character) {
            elements.avatarEmoji.textContent = event.character.avatar || '';
            elements.characterName.textContent = event.character.name || '';
            elements.characterRole.textContent = event.character.role || '';

            const characterSection = document.querySelector('.character-section');
            if (!event.character.name && !event.character.role) {
                characterSection.style.display = 'none';
            } else {
                characterSection.style.display = 'flex';
            }
        }

        elements.leftBtnText.textContent = event.left.text;
        elements.rightBtnText.textContent = event.right.text;
        elements.leftHintText.textContent = event.left.text;
        elements.rightHintText.textContent = event.right.text;

        elements.swipeLeftHint.style.opacity = 0;
        elements.swipeRightHint.style.opacity = 0;

        setupSwipeHandlers();
    }

    // ==================== æ»‘åŠ¨äº‹ä»¶å¤„ç† ====================
    function setupSwipeHandlers() {
        removeEventListeners();
        elements.card.addEventListener('mousedown', startDrag);
        elements.card.addEventListener('touchstart', startDrag, { passive: false });
    }

    function removeEventListeners() {
        elements.card.removeEventListener('mousedown', startDrag);
        elements.card.removeEventListener('touchstart', startDrag);
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);
    }

    function startDrag(e) {
        if (gameState.isAnimating) return;

        e.preventDefault();

        startX = e.clientX || (e.touches && e.touches[0].clientX);
        if (startX === undefined) return;

        isDragging = true;
        currentX = 0;

        elements.card.style.transition = 'none';
        elements.card.classList.add('dragging');

        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    }

    function drag(e) {
        if (!isDragging || gameState.isAnimating) return;

        e.preventDefault();

        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        if (clientX === undefined) return;

        currentX = clientX - startX;

        const maxDrag = window.innerWidth * 0.4;
        currentX = Math.max(-maxDrag, Math.min(maxDrag, currentX));

        const rotation = (currentX / maxDrag) * 5;

        elements.card.style.transform = `translateX(${currentX}px) rotate(${rotation}deg)`;

        const progress = Math.min(Math.abs(currentX) / SWIPE_THRESHOLD, 1);

        if (currentX < 0) {
            elements.swipeLeftHint.style.opacity = progress;
            elements.swipeRightHint.style.opacity = 0;
            elements.swipeLeftHint.style.transform = `scale(${0.8 + progress * 0.4})`;
        } else if (currentX > 0) {
            elements.swipeRightHint.style.opacity = progress;
            elements.swipeLeftHint.style.opacity = 0;
            elements.swipeRightHint.style.transform = `scale(${0.8 + progress * 0.4})`;
        } else {
            elements.swipeLeftHint.style.opacity = 0;
            elements.swipeRightHint.style.opacity = 0;
        }

        const btnLeft = elements.card.querySelector('.card-button-left');
        const btnRight = elements.card.querySelector('.card-button-right');

        if (currentX < -30) {
            highlightButton(btnLeft, true);
            highlightButton(btnRight, false);
        } else if (currentX > 30) {
            highlightButton(btnRight, true);
            highlightButton(btnLeft, false);
        } else {
            highlightButton(btnLeft, false);
            highlightButton(btnRight, false);
        }
    }

    function highlightButton(btn, highlight) {
        if (highlight) {
            btn.style.transform = 'scale(1.08)';
            btn.style.boxShadow = '0 0 18px rgba(255, 255, 255, 0.5)';
        } else {
            btn.style.transform = '';
            btn.style.boxShadow = '';
        }
    }

    function endDrag(e) {
        if (!isDragging || gameState.isAnimating) return;

        isDragging = false;
        elements.card.classList.remove('dragging');

        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);

        const btnLeft = elements.card.querySelector('.card-button-left');
        const btnRight = elements.card.querySelector('.card-button-right');
        highlightButton(btnLeft, false);
        highlightButton(btnRight, false);

        const distance = Math.abs(currentX);

        if (distance >= SWIPE_THRESHOLD) {
            const direction = currentX > 0 ? 'å³' : 'å·¦';

            if (currentX > 0) {
                executeSwipe('right', currentEvent.right.effect);
            } else {
                executeSwipe('left', currentEvent.left.effect);
            }
        } else {
            snapBack();
        }
    }

    function snapBack() {
        elements.card.style.transition = 'transform 0.3s ease-out';
        elements.card.style.transform = 'translateX(0) rotate(0deg)';

        const buttons = elements.card.querySelectorAll('.card-button');
        buttons.forEach(btn => {
            btn.style.animation = 'shake 0.3s';
        });

        setTimeout(() => {
            buttons.forEach(btn => {
                btn.style.animation = '';
            });
            elements.swipeLeftHint.style.opacity = 0;
            elements.swipeRightHint.style.opacity = 0;
            elements.swipeLeftHint.style.transform = '';
            elements.swipeRightHint.style.transform = '';
        }, 300);
    }

    // ==================== æ‰§è¡Œæ»‘åŠ¨ ====================
    function executeSwipe(direction, effect) {
        if (gameState.isAnimating) return;
        gameState.isAnimating = true;

        removeEventListeners();

        const cardButtons = elements.card.querySelectorAll('.card-button');
        cardButtons.forEach(btn => btn.onclick = null);

        if (navigator.vibrate) {
            navigator.vibrate(50);
        }

        flashScreen();

        // æ’­æ”¾æ»‘åŠ¨éŸ³æ•ˆ
        playSound('swipe');

        // æ ¹æ®effectæ­£è´Ÿæ’­æ”¾positive/negativeéŸ³æ•ˆ
        const totalEffect = (effect.E || 0) + (effect.A || 0) + (effect.C || 0) + (effect.S || 0);
        if (totalEffect >= 0) {
            playSound('positive');
        } else {
            playSound('negative');
        }

        const endX = direction === 'right' ? '200%' : '-200%';
        const endRotation = direction === 'right' ? '8deg' : '-8deg';

        elements.card.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        elements.card.style.transform = `translateX(${endX}) rotate(${endRotation})`;

        const btn = direction === 'right'
            ? elements.card.querySelector('.card-button-right')
            : elements.card.querySelector('.card-button-left');
        highlightButton(btn, true);

        setTimeout(() => {
            applyChoiceEffect(effect);

            showFeedback(`ç¬¬${gameState.week}å‘¨ Â· é€‰æ‹©å·²ç”Ÿæ•ˆ`);

            if (checkGameOver()) {
                return;
            }

            elements.card.style.transition = 'none';
            elements.card.style.transform = '';
            elements.card.style.opacity = '0';

            highlightButton(btn, false);

            gameState.week++;
            gameState.daysLeft -= 7;
            const ddlConfig = DIFFICULTY_CONFIG[currentDifficulty].ddlMultiplier;
            gameState.ddlPressure += ddlConfig.min + Math.random() * (ddlConfig.max - ddlConfig.min);

            setTimeout(() => {
                elements.card.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                elements.card.style.transform = 'scale(1)';
                elements.card.style.opacity = '1';

                setTimeout(() => {
                    elements.card.style.transition = '';
                }, 300);
            }, 50);

            nextEvent();
            gameState.isAnimating = false;
        }, 400);
    }

    function flashScreen() {
        const flash = document.createElement('div');
        flash.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            pointer-events: none;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.2s;
        `;
        document.body.appendChild(flash);

        setTimeout(() => {
            flash.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(flash);
            }, 200);
        }, 50);
    }

    // ==================== åº”ç”¨é€‰æ‹©æ•ˆæœ ====================
    function applyChoiceEffect(effect) {
        const config = DIFFICULTY_CONFIG[currentDifficulty];

        if (effect.E) {
            const change = effect.E < 0 ? effect.E * config.negativeMultiplier : effect.E * config.positiveMultiplier;
            gameState.energy = clamp(gameState.energy + change, 0, 100);
        }
        if (effect.A) {
            const change = effect.A < 0 ? effect.A * config.negativeMultiplier : effect.A * config.positiveMultiplier;
            gameState.academics = clamp(gameState.academics + change, 0, 100);
        }
        if (effect.C) {
            const change = effect.C < 0 ? effect.C * config.negativeMultiplier : effect.C * config.positiveMultiplier;
            gameState.connection = clamp(gameState.connection + change, 0, 100);
        }
        if (effect.S) {
            const change = effect.S < 0 ? effect.S * config.negativeMultiplier : effect.S * config.positiveMultiplier;
            gameState.self = clamp(gameState.self + change, 0, 100);
        }

        if (gameState.inHighPressurePeriod && effect.E < 0) {
            const extraLoss = effect.E * (config.highPressureEnergyMultiplier - 1);
            gameState.energy = clamp(gameState.energy + extraLoss, 0, 100);
        }
    }

    function showFeedback(message) {
        elements.feedbackMessage.textContent = message;
        elements.feedbackMessage.classList.add('show');

        setTimeout(() => {
            elements.feedbackMessage.classList.remove('show');
        }, 1500);
    }

    // ==================== æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ ====================
    function checkGameOver() {
        if (gameState.energy <= 0) {
            endGame('energy');
            return true;
        }
        if (gameState.academics <= 0) {
            endGame('academics');
            return true;
        }
        if (gameState.connection <= 0) {
            endGame('connection');
            return true;
        }
        if (gameState.self <= 0) {
            endGame('self');
            return true;
        }
        return false;
    }

    // ==================== ç»“æŸæ¸¸æˆ ====================
    function endGame(type) {
        gameState.gameOver = true;

        removeEventListeners();

        const cardButtons = elements.card.querySelectorAll('.card-button');
        cardButtons.forEach(btn => btn.onclick = null);

        elements.card.style.transition = '';
        elements.card.style.transform = '';
        elements.card.style.opacity = '';
        elements.card.classList.remove('dragging', 'swipe-left-complete', 'swipe-right-complete', 'entering', 'snap-back');

        elements.swipeLeftHint.style.opacity = '0';
        elements.swipeRightHint.style.opacity = '0';
        elements.swipeLeftHint.style.transform = '';
        elements.swipeRightHint.style.transform = '';

        // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
        playSound('gameover');

        let ending;
        if (type === 'semester') {
            const avg = (gameState.energy + gameState.academics + gameState.connection + gameState.self) / 4;
            const maxStat = Math.max(gameState.energy, gameState.academics, gameState.connection, gameState.self);

            if (avg > 60) {
                ending = ENDINGS.semester.balanced;
            } else if (gameState.connection === maxStat) {
                ending = ENDINGS.semester.social;
            } else if (gameState.academics === maxStat) {
                ending = ENDINGS.semester.academic;
            } else if (gameState.self === maxStat) {
                ending = ENDINGS.semester.awakened;
            } else {
                ending = ENDINGS.semester.balanced;
            }
        } else {
            ending = ENDINGS[type];
        }

        if (ending.icon) {
            elements.endingIcon.textContent = ending.icon;
        }
        elements.endingTitle.textContent = ending.title;
        elements.endingText.textContent = ending.text;
        elements.endingStats.innerHTML = `
            <span>â˜• ${Math.round(gameState.energy)}</span>
            <span>ğŸ“– ${Math.round(gameState.academics)}</span>
            <span>â¤ï¸ ${Math.round(gameState.connection)}</span>
            <span>ğŸª ${Math.round(gameState.self)}</span>
        `;

        showScreen('ending');
    }

    // ==================== æ›´æ–°çŠ¶æ€è¿›åº¦æ¡ ====================
    function updateStatusDots() {
        const stats = {
            energy: gameState.energy,
            academics: gameState.academics,
            connection: gameState.connection,
            self: gameState.self
        };

        Object.keys(stats).forEach(statName => {
            const value = stats[statName];
            const elements = statusElements[statName];

            if (elements.fill && elements.dot) {
                elements.fill.style.width = `${value}%`;
                elements.dot.style.left = `calc(${value}% - 7px)`;

                if (value <= 30) {
                    elements.fill.classList.add('low');
                } else {
                    elements.fill.classList.remove('low');
                }
            }
        });
    }

    function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
    }

    // ==================== é”®ç›˜æ§åˆ¶ ====================
    document.addEventListener('keydown', (e) => {
        if (!elements.gameScreen.classList.contains('active') || gameState.isAnimating) return;

        if (e.key === 'ArrowLeft' && currentEvent) {
            executeSwipe('left', currentEvent.left.effect);
        } else if (e.key === 'ArrowRight' && currentEvent) {
            executeSwipe('right', currentEvent.right.effect);
        }
    });

    // ==================== æŒ‰é’®ç‚¹å‡»äº‹ä»¶ ====================
    function setupButtonHandlers() {
        const btnLeft = elements.card.querySelector('.card-button-left');
        const btnRight = elements.card.querySelector('.card-button-right');

        if (btnLeft) {
            btnLeft.onclick = () => {
                if (!gameState.isAnimating && currentEvent) {
                    executeSwipe('left', currentEvent.left.effect);
                }
            };
        }

        if (btnRight) {
            btnRight.onclick = () => {
                if (!gameState.isAnimating && currentEvent) {
                    executeSwipe('right', currentEvent.right.effect);
                }
            };
        }
    }

    // ==================== éš¾åº¦é€‰æ‹©ç›¸å…³å‡½æ•° ====================
    function updateDifficultyPreview(difficulty) {
        const config = DIFFICULTY_CONFIG[difficulty];
        elements.previewIcon.textContent = config.icon;
        elements.previewName.textContent = config.name;
        elements.previewDesc.textContent = config.hint || config.description;

        [elements.diffEasyBtn, elements.diffStandardBtn, elements.diffHardBtn].forEach(btn => {
            btn.classList.remove('selected');
        });

        switch(difficulty) {
            case 'easy':
                elements.diffEasyBtn.classList.add('selected');
                break;
            case 'standard':
                elements.diffStandardBtn.classList.add('selected');
                break;
            case 'hard':
                elements.diffHardBtn.classList.add('selected');
                break;
        }
    }

    function selectDifficulty(difficulty) {
        currentDifficulty = difficulty;
        updateDifficultyPreview(difficulty);
    }

    function startGameWithDifficulty() {
        elements.difficultyCard.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
        elements.difficultyCard.style.transform = 'translateY(-100vh) rotate(10deg)';
        elements.difficultyCard.style.opacity = '0';

        setTimeout(() => {
            elements.difficultyCard.style.transition = '';
            elements.difficultyCard.style.transform = '';
            elements.difficultyCard.style.opacity = '';

            initGame(currentDifficulty);
        }, 500);
    }

    // ==================== åˆå§‹åŒ–äº‹ä»¶ç»‘å®š ====================
    elements.startBtn.addEventListener('click', () => {
        currentDifficulty = 'standard';
        updateDifficultyPreview('standard');
        showScreen('difficulty');
        // åˆå§‹åŒ–éŸ³æ•ˆ
        initAudio();
    });

    elements.restartBtn.addEventListener('click', () => {
        initGame(currentDifficulty);
    });

    elements.diffEasyBtn.addEventListener('click', () => selectDifficulty('easy'));
    elements.diffStandardBtn.addEventListener('click', () => selectDifficulty('standard'));
    elements.diffHardBtn.addEventListener('click', () => selectDifficulty('hard'));
    elements.confirmDifficultyBtn.addEventListener('click', startGameWithDifficulty);

    elements.backToDifficultyBtn.addEventListener('click', () => {
        removeEventListeners();
        showScreen('difficulty');
    });

    const originalNextEvent = nextEvent;
    nextEvent = function() {
        originalNextEvent();
        setupButtonHandlers();
    };

    // ==================== åˆå§‹æ˜¾ç¤ºå¼€å§‹ç•Œé¢ ====================
    showScreen('start');
    updateDifficultyPreview('standard');
    </script>
</body>
</html>
